<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>C&#43;&#43; 學習筆記 - std::shared_ptr | kfwu&#39;s blog</title>
<meta name="keywords" content="C&#43;&#43;">
<meta name="description" content="TL;DR 在上一篇 std::unique_ptr 的筆記中，已經簡短介紹智能指標的目的及用法。
在本篇筆記中，會逐步介紹 std::shared_ptr 的基本概念、用法、及簡易實作。
shared_ptr 簡介 與 unique_ptr 類似，shared_ptr 也是 C&#43;&#43;11 中引入的一種智能指標，其目的是為了減少記憶體流失 (Memory Leak) 的風險。
與 unique_ptr 不同的地方在於，shared_ptr 允許多個 shared_ptr 實例指向同一塊動態記憶體。只有當最後一個 shared_ptr 被銷毀或重置後，該記憶體才會被釋放。
shared_ptr 會維護一個引用計數 (Reference Counting) 來管理記憶體的所有權。每當一個新的 shared_ptr 被創建或複製時，引用計數會增加；而當一個 shared_ptr 被銷毀或重置時，引用計數會減少。當引用計數歸零時，表示不再有指標指向該記憶體，此時記憶體將被自動釋放。
引用計數改變的情況 shared_ptr 的引用計數會在創建或被複製時增加，並在銷毀或重置時減少，主要會在以下幾種情況改變：
建構子 (Constructor) 解構子 (Destructor) 拷貝建構子 (Copy Constructor) 拷貝賦值運算子 (Copy Assignment Operator) 要注意的是，移動建構子 (Move Constructor) 及移動運算子 (Move Assignment Operator) 會有所有權轉移的步驟，在轉移後原本的指標會被設定為空指標，所以引用計數並不會改變。
成員變數與控制區塊 (Control Block) shared_ptr 本身除了指向動態記憶體區塊的指標之外，還有另外一個指標指向一個控制區塊 (Control Block)，如下圖所示。其中控制區塊包含以下內容:
引用計數 弱引用計數: 此與 std::weak_ptr 有關，這邊先略過，會在後續筆記中做介紹 其他資料: 包含 Deletor 及 Allocator 等 而控制區塊會在以下幾種情況被建立：">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/cpp/shared_ptr/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/cpp/shared_ptr/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="kfwu&#39;s blog (Alt + H)">kfwu&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      C&#43;&#43; 學習筆記 - std::shared_ptr
    </h1>
    <div class="post-meta"><span title='2024-09-04 00:00:00 +0000 UTC'>2024.09.04</span>&nbsp;·&nbsp;5 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#tldr">TL;DR</a></li>
    <li><a href="#shared_ptr">shared_ptr</a>
      <ul>
        <li><a href="#簡介">簡介</a></li>
        <li><a href="#引用計數改變的情況">引用計數改變的情況</a></li>
        <li><a href="#成員變數與控制區塊-control-block">成員變數與控制區塊 (Control Block)</a></li>
        <li><a href="#使用-make_shared-的重要性">使用 make_shared 的重要性</a></li>
        <li><a href="#特性">特性</a></li>
      </ul>
    </li>
    <li><a href="#shared_ptr-用法">shared_ptr 用法</a>
      <ul>
        <li><a href="#基本用法">基本用法</a></li>
        <li><a href="#使用-unique_ptr-建立">使用 unique_ptr 建立</a></li>
        <li><a href="#自訂刪除器-custom-deleter">自訂刪除器 (Custom Deleter)</a></li>
        <li><a href="#使用於函式參數">使用於函式參數</a></li>
      </ul>
    </li>
    <li><a href="#實作">實作</a>
      <ul>
        <li><a href="#簡易實作-不含控制區塊及-atomic-操作">簡易實作 (不含控制區塊及 Atomic 操作)</a></li>
      </ul>
    </li>
    <li><a href="#參考資料">參考資料</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="tldr">TL;DR<a hidden class="anchor" aria-hidden="true" href="#tldr">#</a></h2>
<p>在上一篇 <code>std::unique_ptr</code> 的<a href="https://kfwu1999.github.io/posts/cpp/unique_ptr/">筆記</a>中，已經簡短介紹智能指標的目的及用法。</p>
<p>在本篇筆記中，會逐步介紹 <code>std::shared_ptr</code> 的基本概念、用法、及簡易實作。</p>
<hr>
<h2 id="shared_ptr">shared_ptr<a hidden class="anchor" aria-hidden="true" href="#shared_ptr">#</a></h2>
<h3 id="簡介">簡介<a hidden class="anchor" aria-hidden="true" href="#簡介">#</a></h3>
<p>與 <code>unique_ptr</code> 類似，<code>shared_ptr</code> 也是 C++11 中引入的一種智能指標，其目的是為了減少記憶體流失 (Memory Leak) 的風險。</p>
<p>與 <code>unique_ptr</code> 不同的地方在於，<code>shared_ptr</code> 允許多個 <code>shared_ptr</code> 實例指向同一塊動態記憶體。只有當最後一個 <code>shared_ptr</code> 被銷毀或重置後，該記憶體才會被釋放。</p>
<p><code>shared_ptr</code> 會維護一個引用計數 (Reference Counting) 來管理記憶體的所有權。每當一個新的 <code>shared_ptr</code> 被創建或複製時，引用計數會增加；而當一個 <code>shared_ptr</code> 被銷毀或重置時，引用計數會減少。當引用計數歸零時，表示不再有指標指向該記憶體，此時記憶體將被自動釋放。</p>
<h3 id="引用計數改變的情況">引用計數改變的情況<a hidden class="anchor" aria-hidden="true" href="#引用計數改變的情況">#</a></h3>
<p><code>shared_ptr</code> 的引用計數會在創建或被複製時增加，並在銷毀或重置時減少，主要會在以下幾種情況改變：</p>
<ul>
<li>建構子 (Constructor)</li>
<li>解構子 (Destructor)</li>
<li>拷貝建構子 (Copy Constructor)</li>
<li>拷貝賦值運算子 (Copy Assignment Operator)</li>
</ul>
<p>要注意的是，移動建構子 (Move Constructor) 及移動運算子 (Move Assignment Operator) 會有所有權轉移的步驟，在轉移後原本的指標會被設定為空指標，所以引用計數並不會改變。</p>
<h3 id="成員變數與控制區塊-control-block">成員變數與控制區塊 (Control Block)<a hidden class="anchor" aria-hidden="true" href="#成員變數與控制區塊-control-block">#</a></h3>
<p><code>shared_ptr</code> 本身除了指向動態記憶體區塊的指標之外，還有另外一個指標指向一個控制區塊 (Control Block)，如下圖所示。其中控制區塊包含以下內容:</p>
<ul>
<li><strong>引用計數</strong></li>
<li><strong>弱引用計數</strong>: 此與 <code>std::weak_ptr</code> 有關，這邊先略過，會在後續筆記中做介紹</li>
<li><strong>其他資料</strong>: 包含 Deletor 及 Allocator 等</li>
</ul>
<p><img loading="lazy" src="/images/cpp/fig_shared_ptr_member.png" alt="控制區塊 (Control Block)"  />
</p>
<p>而控制區塊會在以下幾種情況被建立：</p>
<ul>
<li>使用 <code>make_shared</code> 建立 <code>shared_ptr</code> 時</li>
<li>使用 <code>unique_ptr</code> 建立 <code>shared_ptr</code> 時</li>
<li>使用 <code>shared_ptr</code> 的原始指標建構子時 (盡量避免此做法)</li>
</ul>
<h3 id="使用-make_shared-的重要性">使用 make_shared 的重要性<a hidden class="anchor" aria-hidden="true" href="#使用-make_shared-的重要性">#</a></h3>
<p>創建 <code>shared_ptr</code> 時要盡量使用 <code>make_shared</code> 進行創建，避免同一個動態記憶體區塊有多個控制區塊進行管理。如以下範例：</p>
<div class="highlight"><div style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">*</span> raw_ptr <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">new</span> <span style="color:#e78284">int</span>(<span style="color:#ef9f76">1</span>);
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sptr1(raw_ptr);
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sptr2(raw_ptr);
</span></span><span style="display:flex;"><span>} <span style="color:#737994;font-style:italic">// double free error
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在此範例中，<code>sptr1</code> 及 <code>sptr2</code> 皆是以原始指標建立 <code>shared_ptr</code>，所以他們都會建立對於 <code>raw_ptr</code> 指向的記憶體的控制區塊。也就是說同一塊記憶體會有兩個控制區塊進行管理。</p>
<p>當 <code>sptr1</code> 的生命週期結束後，<code>sptr1</code> 所指向的控制區塊中的引用計數歸零，並自動清除 <code>raw_ptr</code> 所指向的記憶體。而 <code>sptr2</code> 所指向的控制區塊中的引用計數也會因為生命週期結束而歸零，但要清除記憶體時，該記憶體已被 <code>sptr1</code> 清除，故會造成重複清除錯誤 (Double Free Error)。</p>
<h3 id="特性">特性<a hidden class="anchor" aria-hidden="true" href="#特性">#</a></h3>
<ul>
<li>
<p>大小:</p>
<ul>
<li><code>shared_ptr</code> 的大小比原始指標 (raw pointer) 還大，因為裡面多一個指向控制區塊的指標。</li>
</ul>
</li>
<li>
<p>執行緒安全 (Thread-Safe):</p>
<ul>
<li><code>shared_ptr</code> 中引用計數的增減是原子操作，因此是執行緒安全的，這代表可以多個執行緒安全的使用 <code>shared_ptr</code>。</li>
<li>但 <code>shared_ptr</code> 指向的記憶體本身並不是執行緒安全的，因此會需要額外的同步機制。</li>
</ul>
</li>
<li>
<p>循環引用的問題 (Circular Reference)</p>
<ul>
<li><code>shared_ptr</code> 有時可能會有循環引用的問題，可搭配 <code>weak_ptr</code> 解決問題。這部分我會在後續的筆記中介紹。</li>
</ul>
</li>
<li>
<p>陣列</p>
<ul>
<li><code>shared_ptr</code> 是在 C++17 才引入動態陣列的用法。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="shared_ptr-用法">shared_ptr 用法<a hidden class="anchor" aria-hidden="true" href="#shared_ptr-用法">#</a></h2>
<h3 id="基本用法">基本用法<a hidden class="anchor" aria-hidden="true" href="#基本用法">#</a></h3>
<div class="highlight"><div style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sp1 <span style="color:#99d1db;font-weight:bold">=</span> std<span style="color:#99d1db;font-weight:bold">::</span>make_shared<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span>(<span style="color:#ef9f76">0</span>); <span style="color:#737994;font-style:italic">// 使用 make_shared 創建
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sp2(sp1);                       <span style="color:#737994;font-style:italic">// 複製建構，引用計數增加
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sp3 <span style="color:#99d1db;font-weight:bold">=</span> sp1;                      <span style="color:#737994;font-style:italic">// 複製，引用計數增加
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sp4(std<span style="color:#99d1db;font-weight:bold">::</span>move(sp2));            <span style="color:#737994;font-style:italic">// 移動建構，所有權轉移，引用計數不變，`sp2` 變 `nullptr`
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sp5 <span style="color:#99d1db;font-weight:bold">=</span> std<span style="color:#99d1db;font-weight:bold">::</span>move(sp3);           <span style="color:#737994;font-style:italic">// 所有權轉移，引用計數不變，`sp3` 變 `nullptr`
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>{
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sp6 <span style="color:#99d1db;font-weight:bold">=</span> sp1;                  <span style="color:#737994;font-style:italic">// 引用計數增加
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>} <span style="color:#737994;font-style:italic">// 離開此 scope 後，引用計數減少
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用-unique_ptr-建立">使用 unique_ptr 建立<a hidden class="anchor" aria-hidden="true" href="#使用-unique_ptr-建立">#</a></h3>
<p><code>shared_ptr</code> 可以透過 <code>unique_ptr</code> 建立，此時會建立一個控制區塊 (Control Block)。</p>
<div class="highlight"><div style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#99d1db;font-weight:bold">::</span>unique_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> uptr <span style="color:#99d1db;font-weight:bold">=</span> std<span style="color:#99d1db;font-weight:bold">::</span>make_unique<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span>(<span style="color:#ef9f76">10</span>);
</span></span><span style="display:flex;"><span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> sptr <span style="color:#99d1db;font-weight:bold">=</span> std<span style="color:#99d1db;font-weight:bold">::</span>move(uptr);
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">// `uptr` 變成 `nullptr`，並由 `sptr` 管理該記憶體
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="自訂刪除器-custom-deleter">自訂刪除器 (Custom Deleter)<a hidden class="anchor" aria-hidden="true" href="#自訂刪除器-custom-deleter">#</a></h3>
<p>與 <code>unique_ptr</code> 相同，皆可以使用自訂的刪除器</p>
<div class="highlight"><div style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>FILE<span style="color:#99d1db;font-weight:bold">&gt;</span> file_ptr(fopen(<span style="color:#a6d189">&#34;temp.txt&#34;</span>, <span style="color:#a6d189">&#34;w&#34;</span>), <span style="color:#99d1db;font-weight:bold">&amp;</span>fclose);
</span></span></code></pre></td></tr></table>
</div>
</div><p>在這個範例中，使用 <code>fclose</code> 作為自訂刪除器，當釋放 <code>FILE*</code> 記憶體時，會自動使用 <code>fclose</code> 關閉文件。</p>
<h3 id="使用於函式參數">使用於函式參數<a hidden class="anchor" aria-hidden="true" href="#使用於函式參數">#</a></h3>
<div class="highlight"><div style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#e78284">void</span> <span style="color:#8caaee">call_by_val</span>(std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span> ptr) {
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;call_by_val, use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> ptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e78284">void</span> <span style="color:#8caaee">call_by_ref</span>(std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;&amp;</span> ptr) {
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;call_by_ref, use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> ptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e78284">void</span> <span style="color:#8caaee">call_by_const_ref</span>(<span style="color:#ca9ee6">const</span> std<span style="color:#99d1db;font-weight:bold">::</span>shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;&amp;</span> ptr) {
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;call_by_const_ref, use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> ptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e78284">int</span> <span style="color:#8caaee">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">auto</span> sptr <span style="color:#99d1db;font-weight:bold">=</span> std<span style="color:#99d1db;font-weight:bold">::</span>make_shared<span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">&gt;</span>(<span style="color:#ef9f76">10</span>); <span style="color:#737994;font-style:italic">// Initial shared_ptr with reference count = 1
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;Initial use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> sptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    call_by_val(sptr);
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;After, use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> sptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    call_by_ref(sptr);
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;After, use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> sptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    call_by_const_ref(sptr);
</span></span><span style="display:flex;"><span>    std<span style="color:#99d1db;font-weight:bold">::</span>cout <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> <span style="color:#a6d189">&#34;After, use_count: &#34;</span> <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> sptr.use_count() <span style="color:#99d1db;font-weight:bold">&lt;&lt;</span> std<span style="color:#99d1db;font-weight:bold">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">return</span> <span style="color:#ef9f76">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其輸出結果如下</p>
<pre tabindex="0"><code>Initial use_count: 1
call_by_val, use_count: 2
After, use_count: 1
call_by_ref, use_count: 1
After, use_count: 1
call_by_const_ref, use_count: 1
After, use_count: 1
</code></pre><hr>
<h2 id="實作">實作<a hidden class="anchor" aria-hidden="true" href="#實作">#</a></h2>
<h3 id="簡易實作-不含控制區塊及-atomic-操作">簡易實作 (不含控制區塊及 Atomic 操作)<a hidden class="anchor" aria-hidden="true" href="#簡易實作-不含控制區塊及-atomic-操作">#</a></h3>
<p>實作 <code>shared_ptr</code> 需注意引用計數改變的情況。</p>
<div class="highlight"><div style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#838ba7">137
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ca9ee6">template</span> <span style="color:#99d1db;font-weight:bold">&lt;</span><span style="color:#ca9ee6">typename</span> T<span style="color:#99d1db;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">class</span> <span style="color:#e5c890">shared_ptr</span> {
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">private</span><span style="color:#99d1db;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">using</span> element_type <span style="color:#99d1db;font-weight:bold">=</span> T;
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">using</span> pointer      <span style="color:#99d1db;font-weight:bold">=</span> T<span style="color:#99d1db;font-weight:bold">*</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">using</span> reference    <span style="color:#99d1db;font-weight:bold">=</span> T<span style="color:#99d1db;font-weight:bold">&amp;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">private</span><span style="color:#99d1db;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    pointer p_ptr;
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">int</span><span style="color:#99d1db;font-weight:bold">*</span>    p_ref_count;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">public</span><span style="color:#99d1db;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Constructor
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">constexpr</span> shared_ptr() <span style="color:#ca9ee6">noexcept</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#99d1db;font-weight:bold">:</span> p_ptr(<span style="color:#ca9ee6">nullptr</span>), p_ref_count(<span style="color:#ca9ee6">nullptr</span>) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Constructor
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ca9ee6">explicit</span> <span style="color:#8caaee">shared_ptr</span>(pointer p)
</span></span><span style="display:flex;"><span>        <span style="color:#99d1db;font-weight:bold">:</span> p_ptr(p), p_ref_count(<span style="color:#ca9ee6">new</span> <span style="color:#e78284">int</span>(<span style="color:#ef9f76">1</span>)) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">if</span> (p <span style="color:#99d1db;font-weight:bold">==</span> <span style="color:#ca9ee6">nullptr</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#99d1db;font-weight:bold">*</span>p_ref_count <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ef9f76">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Destructor
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#99d1db;font-weight:bold">~</span>shared_ptr() {
</span></span><span style="display:flex;"><span>        reset();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Copy constructor
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    shared_ptr(<span style="color:#ca9ee6">const</span> shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>element_type<span style="color:#99d1db;font-weight:bold">&gt;&amp;</span> other) 
</span></span><span style="display:flex;"><span>        <span style="color:#99d1db;font-weight:bold">:</span> p_ptr(other.p_ptr), p_ref_count(other.p_ref_count) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">if</span> (p_ptr <span style="color:#99d1db;font-weight:bold">!=</span> <span style="color:#ca9ee6">nullptr</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#99d1db;font-weight:bold">++</span>(<span style="color:#99d1db;font-weight:bold">*</span>p_ref_count);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Copy assignment operator
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>element_type<span style="color:#99d1db;font-weight:bold">&gt;&amp;</span> <span style="color:#ca9ee6">operator</span><span style="color:#99d1db;font-weight:bold">=</span>(<span style="color:#ca9ee6">const</span> shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>element_type<span style="color:#99d1db;font-weight:bold">&gt;&amp;</span> other) {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">if</span> (<span style="color:#ca9ee6">this</span> <span style="color:#99d1db;font-weight:bold">!=</span> <span style="color:#99d1db;font-weight:bold">&amp;</span>other) {
</span></span><span style="display:flex;"><span>            <span style="color:#737994;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>            reset();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#737994;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>            p_ptr <span style="color:#99d1db;font-weight:bold">=</span> other.p_ptr;
</span></span><span style="display:flex;"><span>            p_ref_count <span style="color:#99d1db;font-weight:bold">=</span> other.p_ref_count;
</span></span><span style="display:flex;"><span>            <span style="color:#ca9ee6">if</span> (p_ptr <span style="color:#99d1db;font-weight:bold">!=</span> <span style="color:#ca9ee6">nullptr</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#99d1db;font-weight:bold">++</span>(<span style="color:#99d1db;font-weight:bold">*</span>p_ref_count);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> <span style="color:#99d1db;font-weight:bold">*</span><span style="color:#ca9ee6">this</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Move Constructor
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    shared_ptr(shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>element_type<span style="color:#99d1db;font-weight:bold">&gt;&amp;&amp;</span> other)
</span></span><span style="display:flex;"><span>        <span style="color:#99d1db;font-weight:bold">:</span> p_ptr(other.p_ptr), p_ref_count(other.p_ref_count)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        other.p_ptr <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">nullptr</span>;
</span></span><span style="display:flex;"><span>        other.p_ref_count <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \breif Move Assignment Operator
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>element_type<span style="color:#99d1db;font-weight:bold">&gt;&amp;</span> <span style="color:#ca9ee6">operator</span><span style="color:#99d1db;font-weight:bold">=</span>(shared_ptr<span style="color:#99d1db;font-weight:bold">&lt;</span>element_type<span style="color:#99d1db;font-weight:bold">&gt;&amp;&amp;</span> other) {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">if</span> (<span style="color:#ca9ee6">this</span> <span style="color:#99d1db;font-weight:bold">!=</span> <span style="color:#99d1db;font-weight:bold">&amp;</span>other) {
</span></span><span style="display:flex;"><span>            <span style="color:#737994;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>            reset();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#737994;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>            p_ptr <span style="color:#99d1db;font-weight:bold">=</span> other.p_ptr;
</span></span><span style="display:flex;"><span>            p_ref_count <span style="color:#99d1db;font-weight:bold">=</span> other.p_ref_count;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#737994;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic"></span>            other.p_ptr <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">nullptr</span>;
</span></span><span style="display:flex;"><span>            other.p_ref_count <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">nullptr</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> <span style="color:#99d1db;font-weight:bold">*</span><span style="color:#ca9ee6">this</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">public</span><span style="color:#99d1db;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Dereference operator
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    reference <span style="color:#ca9ee6">operator</span><span style="color:#99d1db;font-weight:bold">*</span>() <span style="color:#ca9ee6">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> <span style="color:#99d1db;font-weight:bold">*</span>p_ptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Arrow operator
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    pointer <span style="color:#ca9ee6">operator</span><span style="color:#99d1db;font-weight:bold">-&gt;</span>() <span style="color:#ca9ee6">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> p_ptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">/* Modifiers */</span>
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">public</span><span style="color:#99d1db;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Replaces the managed object
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">void</span> reset() <span style="color:#ca9ee6">noexcept</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">if</span> (p_ref_count <span style="color:#99d1db;font-weight:bold">!=</span> <span style="color:#ca9ee6">nullptr</span> <span style="color:#99d1db;font-weight:bold">&amp;&amp;</span> <span style="color:#99d1db;font-weight:bold">--</span>(<span style="color:#99d1db;font-weight:bold">*</span>p_ref_count) <span style="color:#99d1db;font-weight:bold">==</span> <span style="color:#ef9f76">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ca9ee6">delete</span> p_ptr;
</span></span><span style="display:flex;"><span>            <span style="color:#ca9ee6">delete</span> p_ref_count;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        p_ptr <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">nullptr</span>;
</span></span><span style="display:flex;"><span>        p_ref_count <span style="color:#99d1db;font-weight:bold">=</span> <span style="color:#ca9ee6">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">/* Observers */</span>
</span></span><span style="display:flex;"><span><span style="color:#ca9ee6">public</span><span style="color:#99d1db;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Get the underlying pointer
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    pointer get() <span style="color:#ca9ee6">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> p_ptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#737994;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     * \brief Get the reference count
</span></span></span><span style="display:flex;"><span><span style="color:#737994;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e78284">int</span> <span style="color:#8caaee">use_count</span>() <span style="color:#ca9ee6">const</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ca9ee6">return</span> p_ref_count <span style="color:#99d1db;font-weight:bold">!=</span> <span style="color:#ca9ee6">nullptr</span> <span style="color:#99d1db;font-weight:bold">?</span> <span style="color:#99d1db;font-weight:bold">*</span><span style="color:#99d1db">p_ref_count</span> : <span style="color:#ef9f76">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此實作是簡化版的 <code>shared_ptr</code>，只使用了 <code>p_ref_count</code> 計算引用計數，並未建立控制區塊。</li>
<li>此實作並未在引用計數增減的部分使用原子化 (Atomic) 操作，因此並不是執行緒安全的。</li>
<li>此實作並未使用自訂刪除器的功能。</li>
<li>與 <code>unique_ptr</code>，<code>shared_ptr</code> 是透過更改 <code>*</code> 及 <code>-&gt;</code> 這兩個操作符，使得 <code>shared_ptr</code> 可以像原始指標一樣操作。</li>
</ul>
<hr>
<h2 id="參考資料">參考資料<a hidden class="anchor" aria-hidden="true" href="#參考資料">#</a></h2>
<ul>
<li><a href="https://www.amazon.com/Effective-Modern-Specific-Ways-Improve/dp/1491903996">Effective Modern C++</a>, Item 19</li>
<li><a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">cppreference: shared_ptr</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">kfwu&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
